{"name":"Gestión de Citas - Salón de Belleza","nodes":[{"parameters":{"authentication":"cloudApi","phoneNumberId":"={{$env.WHATSAPP_PHONE_NUMBER_ID}}","propertyValues":{"updates":["messages"]}},"name":"WhatsApp Trigger","type":"n8n-nodes-base.whatsappTrigger"},{"parameters":{"functionCode":"// Extraer datos del mensaje\nconst inputData = items[0].json;\nconst message = inputData.entry?.[0]?.changes?.[0]?.value?.messages?.[0];\n\nif (!message) return {json:{error:true}};\n\n// Extraer texto y número\nconst text = message.text?.body?.toLowerCase() || '';\nconst phone = message.from;\n\n// Detectar intención\nconst intent = \n  text.includes('agendar') || text.includes('cita') ? 'AGENDAR' :\n  text.includes('modificar') || text.includes('cambiar') ? 'MODIFICAR' :\n  text.includes('cancelar') ? 'CANCELAR' :\n  'CONSULTA';\n\n// Extraer fecha y hora\nconst dateRegex = /\\b\\d{1,2}[\\/\\-]\\d{1,2}[\\/\\-]\\d{2,4}\\b/;\nconst timeRegex = /\\b\\d{1,2}(?::\\d{2})?\\s*(?:am|pm)?\\b/i;\n\nconst dateMatch = text.match(dateRegex);\nconst timeMatch = text.match(timeRegex);\n\n// Extraer servicio\nconst service = \n  text.includes('corte') ? 'Corte de cabello' :\n  text.includes('tinte') ? 'Tinte completo' :\n  text.includes('manicure') ? 'Manicure' :\n  text.includes('pedicure') ? 'Pedicure' :\n  text.includes('facial') ? 'Tratamiento facial' : null;\n\n// Duración y precio del servicio\nlet duration = 0;\nlet price = 0;\n\nswitch(service) {\n  case 'Corte de cabello':\n    duration = 30;\n    price = 25;\n    break;\n  case 'Tinte completo':\n    duration = 120;\n    price = 50;\n    break;\n  case 'Manicure':\n    duration = 45;\n    price = 50;\n    break;\n  case 'Pedicure':\n    duration = 60;\n    price = 35;\n    break;\n  case 'Tratamiento facial':\n    duration = 60;\n    price = 45;\n    break;\n}\n\n// Generar ID único para la cita\nconst citaId = 'CT' + Date.now().toString().slice(-6);\n\nreturn {\n  json: {\n    citaId,\n    phone,\n    intent,\n    service,\n    duration,\n    price,\n    date: dateMatch ? dateMatch[0] : null,\n    time: timeMatch ? timeMatch[0] : null,\n    originalText: text,\n    timestamp: new Date().toISOString()\n  }\n};"},"name":"Procesar Mensaje","type":"n8n-nodes-base.function"},{"parameters":{"rules":[{"value1":"={{$json.intent}}","operation":"equal","value2":"AGENDAR"},{"value1":"={{$json.intent}}","operation":"equal","value2":"MODIFICAR"},{"value1":"={{$json.intent}}","operation":"equal","value2":"CANCELAR"}],"fallbackOutput":"3"},"name":"Router","type":"n8n-nodes-base.switch"},{"parameters":{"operation":"lookup","sheetId":"={{$env.GOOGLE_SHEETS_ID}}","range":"Clientes!A:F","lookupColumn":"Numero_WhatsApp","lookupValue":"={{$json.phone}}","options":{"continue":true}},"name":"Verificar Cliente","type":"n8n-nodes-base.googleSheets"},{"parameters":{"functionCode":"// Verificar horario de atención\nconst date = new Date($json.date + ' ' + $json.time);\nconst dayOfWeek = date.getDay();\nconst hours = date.getHours();\nconst minutes = date.getMinutes();\n\n// Verificar si es domingo\nif (dayOfWeek === 0) {\n  return {\n    json: {\n      ...item.json,\n      available: false,\n      reason: 'Lo siento, no atendemos los domingos.'\n    }\n  };\n}\n\n// Verificar horario entre semana\nif (dayOfWeek >= 1 && dayOfWeek <= 5) {\n  if (hours < 9 || (hours === 18 && minutes > 0) || hours > 18) {\n    return {\n      json: {\n        ...item.json,\n        available: false,\n        reason: 'El horario de atención de lunes a viernes es de 9:00 a 18:00.'\n      }\n    };\n  }\n}\n\n// Verificar horario sábado\nif (dayOfWeek === 6) {\n  if (hours < 9 || (hours === 14 && minutes > 0) || hours > 14) {\n    return {\n      json: {\n        ...item.json,\n        available: false,\n        reason: 'El horario de atención los sábados es de 9:00 a 14:00.'\n      }\n    };\n  }\n}\n\n// Verificar que la cita termine dentro del horario\nconst endTime = new Date(date.getTime() + $json.duration * 60000);\nconst endHours = endTime.getHours();\nconst endMinutes = endTime.getMinutes();\n\nif (dayOfWeek >= 1 && dayOfWeek <= 5 && (endHours > 18 || (endHours === 18 && endMinutes > 0))) {\n  return {\n    json: {\n      ...item.json,\n      available: false,\n      reason: 'La duración del servicio excede el horario de cierre.'\n    }\n  };\n}\n\nif (dayOfWeek === 6 && (endHours > 14 || (endHours === 14 && endMinutes > 0))) {\n  return {\n    json: {\n      ...item.json,\n      available: false,\n      reason: 'La duración del servicio excede el horario de cierre del sábado.'\n    }\n  };\n}\n\nreturn {\n  json: {\n    ...item.json,\n    available: true,\n    endTime: endTime.toISOString()\n  }\n};"},"name":"Verificar Disponibilidad","type":"n8n-nodes-base.function"},{"parameters":{"operation":"getEvents","calendar":"={{$env.GOOGLE_CALENDAR_ID}}","timeMin":"={{new Date($json.date + ' ' + $json.time).toISOString()}}","timeMax":"={{$json.endTime}}","singleEvents":true,"orderBy":"startTime"},"name":"Verificar Calendario","type":"n8n-nodes-base.googleCalendar"},{"parameters":{"functionCode":"// Verificar si hay eventos en el rango de tiempo\nconst events = $json.items || [];\n\nif (events.length > 0) {\n  return {\n    json: {\n      ...item.json,\n      available: false,\n      reason: 'El horario seleccionado no está disponible. Por favor, elige otro horario.'\n    }\n  };\n}\n\nreturn item;"},"name":"Procesar Disponibilidad","type":"n8n-nodes-base.function"},{"parameters":{"operation":"append","sheetId":"={{$env.GOOGLE_SHEETS_ID}}","range":"Clientes!A:F","options":{"valueInputMode":"USER_ENTERED"},"data":"={{ [[  'CL' + Date.now().toString().slice(-6),  $json.phone,  'Cliente Nuevo',  $json.service,  new Date().toISOString(),  '' ]] }}"},"name":"Crear/Actualizar Cliente","type":"n8n-nodes-base.googleSheets"},{"parameters":{"operation":"create","calendar":"={{$env.GOOGLE_CALENDAR_ID}}","summary":"={{$json.service}} - {{$json.phone}}","description":"Cita agendada vía WhatsApp\nTeléfono: {{$json.phone}}\nServicio: {{$json.service}}\nPrecio: {{$json.price}}€","start":"={{new Date($json.date + ' ' + $json.time).toISOString()}}","end":"={{$json.endTime}}"},"name":"Crear Cita","type":"n8n-nodes-base.googleCalendar"},{"parameters":{"operation":"append","sheetId":"={{$env.GOOGLE_SHEETS_ID}}","range":"Citas!A:K","options":{"valueInputMode":"USER_ENTERED"},"data":"={{ [[ $json.citaId, $json.phone, new Date($json.date + ' ' + $json.time).toISOString(), $json.service, $json.price, 'Confirmada', 'No', 'No', 'No' ]] }}"},"name":"Registrar Cita","type":"n8n-nodes-base.googleSheets"},{"parameters":{"operation":"sendMessage","authentication":"cloudApi","phoneNumberId":"={{$env.WHATSAPP_PHONE_NUMBER_ID}}","targetPhoneNumber":"={{$json.phone}}","message":"={{ \n$json.available === false ? \n  $json.reason : \n$json.intent === 'AGENDAR' ? \n  `¡Cita confirmada! Te esperamos el ${$json.date} a las ${$json.time} para tu ${$json.service}. Duración: ${$json.duration} minutos. Precio: ${$json.price}€\\n\\nRecibirás recordatorios 2 días y 2 horas antes de tu cita.` : \n$json.intent === 'MODIFICAR' ? \n  'Tu cita ha sido modificada exitosamente.' : \n$json.intent === 'CANCELAR' ? \n  'Tu cita ha sido cancelada.' : \n  'Lo siento, no pude procesar tu solicitud.'\n}}"},"name":"Enviar Confirmación","type":"n8n-nodes-base.whatsapp"}],"connections":{"WhatsApp Trigger":{"main":[[{"node":"Procesar Mensaje","type":"main","index":0}]]},"Procesar Mensaje":{"main":[[{"node":"Router","type":"main","index":0}]]},"Router":{"main":[[{"node":"Verificar Cliente","type":"main","index":0}],[{"node":"Verificar Cliente","type":"main","index":0}],[{"node":"Verificar Cliente","type":"main","index":0}]]},"Verificar Cliente":{"main":[[{"node":"Verificar Disponibilidad","type":"main","index":0}]]},"Verificar Disponibilidad":{"main":[[{"node":"Verificar Calendario","type":"main","index":0}]]},"Verificar Calendario":{"main":[[{"node":"Procesar Disponibilidad","type":"main","index":0}]]},"Procesar Disponibilidad":{"main":[[{"node":"Crear/Actualizar Cliente","type":"main","index":0}]]},"Crear/Actualizar Cliente":{"main":[[{"node":"Crear Cita","type":"main","index":0}]]},"Crear Cita":{"main":[[{"node":"Registrar Cita","type":"main","index":0}]]},"Registrar Cita":{"main":[[{"node":"Enviar Confirmación","type":"main","index":0}]]}}}